{
  "name": "Barometer - STM32",
  "tagline": "",
  "body": "<a href=\"https://loruro.github.io/\"><sub>⟵ Back</sub></a>\r\n\r\nPurpose of the project was to connect [STM32F4 Discovery](https://github.com/loruro/Barometer_STM32/blob/master/datasheets/STM32F4_Discovery_User_manual.pdf) board to two pressure sensors:\r\n* [BMP180](https://github.com/loruro/Barometer_STM32/blob/master/datasheets/BMP180_datasheet.pdf) placed on [BOOSTXL-SENSHUB](https://github.com/loruro/Barometer_STM32/blob/master/datasheets/BOOSTXL-SENSHUB_User_manual.pdf) board\r\n* [MPL115A1](https://github.com/loruro/Barometer_STM32/blob/master/datasheets/MPL115A1_datasheet.pdf) placed on [KAmodBAR-SPI](https://github.com/loruro/Barometer_STM32/blob/master/datasheets/KAMODBAR-SPI.pdf) board\r\n\r\nperform some measurements and compare both sensor.\r\n\r\nSTM32F4 Discovery board has STM32F407VGT6 microcontroller with ARM Cortex-M4 core. The board also includes ST-LINK/V2 debugger and multiple sensors which are not used in this project.  \r\nTo communicate with PC I used UART interface. Between Discovery board and PC there was a simple [USB/UART converter](https://github.com/loruro/Barometer_STM32/blob/master/datasheets/USB-UART_converter.pdf). All output from board could be easily read in terminal application.  \r\nSchematic of all connections between boards is [here](https://github.com/loruro/Barometer_STM32/blob/master/schematic.pdf).\r\n<div align=\"center\"><img src=\"https://raw.githubusercontent.com/loruro/Barometer_STM32/master/img/Barometer_STM32.jpg\" width=\"360\"/></div>\r\n\r\nSpecification taken from datasheets:\r\n\r\n|                             | MPL115A1          | BMP180           |\r\n| --------------------------- |:-----------------:| :--------------: |\r\n| Range                       | 500-1150 hPa      | 300-1100 hPa     |\r\n| Accuracy                    | ±10 hPa           | ±0,12 hPa        |\r\n| Resolution                  | 1.5 hPa           | 0.01 hPa         |\r\n| Interface                   | SPI               | I²C              |\r\n| Supply voltage              | 2.375 V – 5.5 V   | 1.8 V – 3.6 V    |\r\n| Operating Temperature Range | -40 °C to +105 °C | -40 °C to +85 °C |\r\nAs we can see, datasheets declare that BMP180 is much better in terms of accuracy and resolution than MPL115A1.\r\n\r\n## Software\r\n\r\nSoftware for STM32 uses STM32CubeF4 1.13.0 libraries and files generated by STM32CubeMX 4.16.0 application.  \r\nProcedure of measuring pressure was based upon sensors datasheet.\r\n\r\nFirst thing is to read calibration coefficients stored inside both of sensors. These coefficients are unique for every piece of sensor. They are read once, at the program initialization. They will be needed later.\r\n\r\nSecond thing is to send control command to sensor so it will start temperature and pressure conversion (both sensors measure temperature because it is necessary for correct pressure calculation).  \r\nIn case of MPL115A1, there is one command which starts conversion of both pressure and temperature. After 3 ms both values are ready and can be read from sensor.  \r\nIn case of BMP180, there are separate commands for pressure and temperature conversion. Both conversions store measured value inside the same register so it have to be read after each conversion. Conversion time for temperature equals 4.5 ms. In case of pressure, conversion command contains value specifying accuracy of measurement. It is called oversampling rate and it ranges between 0 and 3. Conversion time depends on this value and ranges between 4.5 ms and 25.5 ms.  \r\nIn this project I used simple delay function to wait for an end of pressure and temperature conversions. Because of simplicity of program, this approach works correctly. For more complex applications delay functions are unacceptable and different methods should be used (e.g. timers, interrupts).\r\n\r\nAfter successful conversion, correct value of pressure has to be calculated. Formulas are given in datasheets. For these calculations all data previously read from sensor is used: pressure, temperature and coefficients. As a bonus, correct value of temperature measured by BMP180 sensor can also be calculated. Thanks to proper formula inside datasheet.\r\n\r\nTo increase accuracy, arithmetic mean value is calculated of every 16 measurements. Afterwards, values are sent to PC by UART interface.  \r\nAfter each measurement, state of LEDs on Discovery board is changed so the light jumps and draws circlelike shape.  \r\nThere is also simpe error handling implemented. If error occurs (e.g. connection between Discovery board and sensor brokes), program will stop performing measurements and will blink onboard LEDs.\r\n\r\n## Tests\r\n\r\nFor the most of the tests, BMP180 used oversampling rate 3.\r\n\r\nFirst test was to compare both sensors with commercial, home weather station.\r\n<div align=\"center\"><img src=\"https://raw.githubusercontent.com/loruro/Barometer_STM32/master/img/Weather_station.jpg\" width=\"240\"/></div>\r\nMeasurements for all devices were done in the same time:\r\n\r\n|                 | Pressure | Temperature |\r\n| --------------- |:--------:| :---------: |\r\n| MPL115A1        | 967 hPa  | ---         |\r\n| BMP180          | 973 hPa  | 24.9 °C     |\r\n| Weather station | 964 hPa  | 23.0 °C     |\r\nAll devices gave different results. I couldn't decide which was the most correct.  \r\n\r\nSecond test involved comparing results of MPL115A1 and BMP180 sensors while altitude was changing. I chose two relatively high buildings inside the campus of my university [AGH University of Science and Technology](http://www.agh.edu.pl/en):\r\n\r\n<center>\r\n\r\n| <img src=\"https://raw.githubusercontent.com/loruro/Barometer_STM32/master/img/AGH_Kapitol.png\" width=\"240\"/> | <img src=\"https://raw.githubusercontent.com/loruro/Barometer_STM32/master/img/AGH_B5.jpg\" width=\"240\"/> |\r\n| :------------------------------------------: |:---------------------------------------:|\r\n| Kapitol<br><sub>Source: <a href=\"https://pl.wikipedia.org/wiki/Miasteczko_Studenckie_AGH\">Wikipedia</a></sub> | B5<br><sub>Source: <a href=\"http://www.skyscrapercity.com/showthread.php?t=297606&page=296\">skyscrapercity.com</a></sub> |\r\n\r\n</center>\r\n\r\nMeasurements was made while going up and down the stairs. Charts are generated by MATLAB script. I compared measured values with values approximated by barometric formula:\r\n<div align=\"center\"><img src=\"https://raw.githubusercontent.com/loruro/Barometer_STM32/master/img/barometric_formula.png\" width=\"180\"/></div>\r\nwhere:\r\n* p₀ - atmospheric pressure at reference point\r\n* μ - molar mass of air (0,0289644 kg/mol)\r\n* g - gravitational acceleration (9.80665 m/s²)\r\n* h - current altitude\r\n* R - gas constant (8.3144598 J/(mol*K))\r\n* T - temperature in Kelvins\r\n\r\nResults:\r\n\r\n<center>\r\n\r\n| Pressure                                            | Temperature                                         |\r\n| :-------------------------------------------------: |:---------------------------------------------------:|\r\n| <img src=\"https://raw.githubusercontent.com/loruro/Barometer_STM32/master/measurements/charts/01.png\" width=\"420\"/> | <img src=\"https://raw.githubusercontent.com/loruro/Barometer_STM32/master/measurements/charts/02.png\" width=\"420\"/> |\r\n| <img src=\"https://raw.githubusercontent.com/loruro/Barometer_STM32/master/measurements/charts/03.png\" width=\"420\"/> | <img src=\"https://raw.githubusercontent.com/loruro/Barometer_STM32/master/measurements/charts/04.png\" width=\"420\"/> |\r\n| <img src=\"https://raw.githubusercontent.com/loruro/Barometer_STM32/master/measurements/charts/05.png\" width=\"420\"/> | <img src=\"https://raw.githubusercontent.com/loruro/Barometer_STM32/master/measurements/charts/06.png\" width=\"420\"/> |\r\n| <img src=\"https://raw.githubusercontent.com/loruro/Barometer_STM32/master/measurements/charts/07.png\" width=\"420\"/> | <img src=\"https://raw.githubusercontent.com/loruro/Barometer_STM32/master/measurements/charts/08.png\" width=\"420\"/> |\r\n\r\n</center>\r\n\r\nAs we can see, measurements from BMP180 were much more stable. There is significant offset between sensors. Also the curve created from barometric formula is quite well aligned for both sensors.\r\n\r\nThird test involved leaving both sensors in stable environment for a few minutes. Arithmetic mean value calculation of 16 samples was disabled. Different oversampling rate of BMP180 was checked during test. Results were displayed in form of histograms:\r\n\r\n<center>\r\n\r\n| <img src=\"https://raw.githubusercontent.com/loruro/Barometer_STM32/master/measurements/charts/09.png\" width=\"420\"/> | <img src=\"https://raw.githubusercontent.com/loruro/Barometer_STM32/master/measurements/charts/10.png\" width=\"420\"/> |\r\n| :-------------------------------------------------: |:---------------------------------------------------:|\r\n| <img src=\"https://raw.githubusercontent.com/loruro/Barometer_STM32/master/measurements/charts/11.png\" width=\"420\"/> | <img src=\"https://raw.githubusercontent.com/loruro/Barometer_STM32/master/measurements/charts/12.png\" width=\"420\"/> |\r\n| <img src=\"https://raw.githubusercontent.com/loruro/Barometer_STM32/master/measurements/charts/13.png\" width=\"420\"/> | <img src=\"https://raw.githubusercontent.com/loruro/Barometer_STM32/master/measurements/charts/14.png\" width=\"420\"/> |\r\n\r\n</center>\r\n\r\nSome of the expected values are visibly missing. Also most of the histograms do not look like normal distribution. Only the histogram of BMP180 sensor with oversampling rate of 3 looks almost like Gaussian bell. This could be caused by a bug in software, hardware or not proper power supply of pressure sensors.\r\n\r\n## Conclusion\r\n\r\nBoth sensors worked as expected and were consistent with their datasheets. Tests proved that BMP180 sensor is much more accurate than MPL115A1.  \r\nSTM32F4 Discovery board did the job. Programming with popular HAL libraries was unexpectedly easy.\r\n\r\nWriting software for these pressure sensors was a pleasant experience and teached me something new about technology in our everyday life.\r\n\r\n<a href=\"https://loruro.github.io/\"><sub>⟵ Back</sub></a>",
  "note": "Don't delete this file! It's used internally to help with page regeneration."
}